<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NC Sales Territory Map</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <style>
        :root {
            --mw-navy: #1a2a3a;
            --mw-navy-light: #2d4052;
            --mw-orange: #f7941d;
            --mw-orange-hover: #e8850a;
            --mw-gray-light: #f5f5f5;
            --mw-gray: #e0e0e0;
            --mw-gray-dark: #666;
            --mw-text: #333;
            --mw-white: #ffffff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: var(--mw-gray-light);
            color: var(--mw-text);
        }

        .container {
            display: flex;
            height: 100vh;
            max-width: 1600px;
            margin: 0 auto;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* Sidebar */
        .sidebar {
            width: 340px;
            background: var(--mw-white);
            border-right: 1px solid var(--mw-gray);
            display: flex;
            flex-direction: column;
            overflow: visible;
            transition: margin-left 0.3s ease, opacity 0.3s ease;
            position: relative;
        }

        .sidebar.collapsed {
            margin-left: -340px;
        }

        .sidebar-toggle {
            position: absolute;
            top: 50%;
            right: -32px;
            transform: translateY(-50%);
            width: 32px;
            height: 64px;
            background: var(--mw-navy);
            border: none;
            border-radius: 0 6px 6px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--mw-white);
            font-size: 16px;
            z-index: 100;
            transition: background 0.2s;
        }

        .sidebar-toggle:hover {
            background: var(--mw-navy-light);
        }

        .sidebar.collapsed .sidebar-toggle {
            right: -32px;
        }

        /* State Tabs */
        .state-tabs {
            display: flex;
            background: var(--mw-navy);
            border-bottom: 1px solid var(--mw-navy-light);
        }

        .state-tab {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: transparent;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 1px;
            transition: all 0.2s;
        }

        .state-tab:hover {
            background: var(--mw-navy-light);
            color: var(--mw-white);
        }

        .state-tab.active {
            background: var(--mw-navy-light);
            color: var(--mw-white);
            border-bottom: 3px solid var(--mw-orange);
        }

        .sidebar-header {
            padding: 24px 20px;
            background: var(--mw-navy);
            color: var(--mw-white);
            border-bottom: 4px solid var(--mw-orange);
        }

        .sidebar-header h1 {
            font-size: 20px;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .sidebar-header .subtitle {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .sidebar-header .hint {
            font-size: 11px;
            opacity: 0.6;
            margin-top: 8px;
            font-style: italic;
        }

        .sidebar-section {
            padding: 20px;
            border-bottom: 1px solid var(--mw-gray);
        }

        .sidebar-section h2 {
            font-size: 13px;
            font-weight: 600;
            color: var(--mw-navy);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 14px;
        }

        /* Zone Form */
        .add-zone-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .add-zone-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .add-zone-row input[type="text"] {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid var(--mw-gray);
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .add-zone-row input[type="text"]:focus {
            outline: none;
            border-color: var(--mw-orange);
        }

        .add-zone-row input[type="color"] {
            width: 36px;
            height: 36px;
            border: 2px solid var(--mw-gray);
            border-radius: 4px;
            cursor: pointer;
            padding: 2px;
        }

        .add-zone-row input[type="number"] {
            width: 70px;
            padding: 8px 10px;
            border: 2px solid var(--mw-gray);
            border-radius: 4px;
            font-size: 14px;
        }

        .add-zone-row input[type="number"]:focus {
            outline: none;
            border-color: var(--mw-orange);
        }

        .add-zone-row label {
            font-size: 13px;
            color: var(--mw-gray-dark);
            white-space: nowrap;
        }

        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--mw-orange);
            color: var(--mw-white);
        }

        .btn-primary:hover {
            background: var(--mw-orange-hover);
            transform: translateY(-1px);
        }

        .btn-danger {
            background: #c0392b;
            color: var(--mw-white);
        }

        .btn-danger:hover {
            background: #a93226;
        }

        .btn-secondary {
            background: var(--mw-navy);
            color: var(--mw-white);
        }

        .btn-secondary:hover {
            background: var(--mw-navy-light);
        }

        .btn-sm {
            padding: 6px 10px;
            font-size: 11px;
        }

        /* Zone List */
        .rep-list {
            flex: 1;
            overflow-y: auto;
            padding: 0 20px 20px;
        }

        .rep-item {
            display: flex;
            align-items: center;
            padding: 14px;
            background: var(--mw-gray-light);
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 4px solid var(--mw-orange);
            transition: box-shadow 0.2s;
        }

        .rep-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .rep-color {
            width: 28px;
            height: 28px;
            border-radius: 4px;
            margin-right: 14px;
            border: 2px solid rgba(0,0,0,0.1);
        }

        .rep-info {
            flex: 1;
        }

        .rep-name {
            font-weight: 600;
            color: var(--mw-navy);
        }

        .rep-counties {
            font-size: 12px;
            color: var(--mw-gray-dark);
            margin-top: 3px;
        }

        .rep-actions {
            display: flex;
            gap: 6px;
        }

        /* Statistics */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .stat-card {
            background: var(--mw-gray-light);
            padding: 16px;
            border-radius: 6px;
            text-align: center;
            border-top: 3px solid var(--mw-navy);
        }

        .stat-card.highlight {
            border-top-color: var(--mw-orange);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--mw-navy);
        }

        .stat-label {
            font-size: 11px;
            color: var(--mw-gray-dark);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        /* Map Container */
        .map-container {
            flex: 1;
            position: relative;
            background: linear-gradient(135deg, #e8eef3 0%, #d4dce4 100%);
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .county {
            stroke: var(--mw-white);
            stroke-width: 1px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .county:hover {
            opacity: 0.85;
            stroke: var(--mw-navy);
            stroke-width: 2px;
        }

        .county.unassigned {
            fill: #d0d8e0;
        }

        .county-label {
            font-size: 8px;
            fill: var(--mw-navy);
            pointer-events: none;
            text-anchor: middle;
            font-weight: 500;
        }

        /* Tooltip */
        .tooltip {
            position: absolute;
            background: var(--mw-navy);
            color: var(--mw-white);
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 13px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 100;
            max-width: 220px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            border-left: 4px solid var(--mw-orange);
        }

        .tooltip.visible {
            opacity: 1;
        }

        .tooltip-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .tooltip-rep {
            color: var(--mw-orange);
        }

        /* Assignment Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26, 42, 58, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--mw-white);
            border-radius: 8px;
            padding: 0;
            min-width: 340px;
            max-width: 420px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .modal-header {
            background: var(--mw-navy);
            color: var(--mw-white);
            padding: 18px 24px;
            border-bottom: 4px solid var(--mw-orange);
        }

        .modal h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .modal-body {
            padding: 24px;
        }

        .modal select {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid var(--mw-gray);
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .modal select:focus {
            outline: none;
            border-color: var(--mw-orange);
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Modal Create Zone Section */
        .modal-create-zone {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--mw-gray);
        }

        .create-zone-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-size: 13px;
            color: var(--mw-gray-dark);
            padding: 8px 0;
        }

        .create-zone-header:hover {
            color: var(--mw-orange);
        }

        .expand-icon {
            font-weight: bold;
            font-size: 16px;
        }

        .create-zone-form {
            margin-top: 12px;
        }

        .create-zone-form input[type="text"] {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--mw-gray);
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 12px;
        }

        .create-zone-form input[type="text"]:focus {
            outline: none;
            border-color: var(--mw-orange);
        }

        .create-zone-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .create-zone-row label {
            font-size: 13px;
            color: var(--mw-gray-dark);
            white-space: nowrap;
        }

        .create-zone-row input[type="color"] {
            width: 36px;
            height: 36px;
            border: 2px solid var(--mw-gray);
            border-radius: 4px;
            cursor: pointer;
            padding: 2px;
        }

        .create-zone-row input[type="number"] {
            width: 70px;
            padding: 8px 10px;
            border: 2px solid var(--mw-gray);
            border-radius: 4px;
            font-size: 14px;
        }

        .create-zone-row input[type="number"]:focus {
            outline: none;
            border-color: var(--mw-orange);
        }

        .create-zone-form .btn {
            width: 100%;
        }

        /* Export Button */
        .export-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            z-index: 50;
        }

        /* Legend */
        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: var(--mw-white);
            padding: 18px;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            max-width: 260px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 50;
            border-top: 4px solid var(--mw-orange);
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .legend.hidden {
            transform: translateX(calc(100% + 40px));
            opacity: 0;
            pointer-events: none;
        }

        .legend-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
        }

        .legend-header h3 {
            margin: 0;
        }

        .legend-close {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--mw-gray-dark);
            font-size: 18px;
            padding: 0;
            line-height: 1;
            transition: color 0.2s;
        }

        .legend-close:hover {
            color: var(--mw-navy);
        }

        .legend-show-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: var(--mw-white);
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: var(--mw-navy);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 49;
            transition: all 0.3s ease;
            opacity: 0;
            pointer-events: none;
        }

        .legend-show-btn.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .legend-show-btn:hover {
            background: var(--mw-gray-light);
        }

        .legend h3 {
            font-size: 12px;
            text-transform: uppercase;
            color: var(--mw-navy);
            letter-spacing: 0.5px;
            font-weight: 600;
            margin: 0;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 13px;
            color: var(--mw-text);
        }

        .legend-color {
            width: 18px;
            height: 18px;
            border-radius: 3px;
            margin-right: 10px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .legend-section {
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid var(--mw-gray);
        }

        .legend-section h4 {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--mw-navy);
            margin-bottom: 10px;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .price-legend-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
            color: var(--mw-text);
        }

        .price-legend-item .county-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 8px;
        }

        .price-legend-item .price-value {
            font-weight: 600;
            white-space: nowrap;
        }

        .price-value.positive {
            color: #27ae60;
        }

        .price-value.negative {
            color: #c0392b;
        }

        /* Zoom Controls */
        .zoom-controls {
            position: absolute;
            top: 16px;
            left: 16px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            z-index: 50;
        }

        .zoom-btn {
            width: 40px;
            height: 40px;
            background: var(--mw-white);
            border: 2px solid var(--mw-gray);
            border-radius: 4px;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--mw-navy);
            transition: all 0.2s;
        }

        .zoom-btn:hover {
            background: var(--mw-orange);
            border-color: var(--mw-orange);
            color: var(--mw-white);
        }

        /* Map Options */
        .map-options {
            position: absolute;
            top: 16px;
            left: 70px;
            display: flex;
            gap: 8px;
            z-index: 50;
        }

        .map-option-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: var(--mw-white);
            border: 2px solid var(--mw-gray);
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            color: var(--mw-navy);
            cursor: pointer;
            transition: all 0.2s;
        }

        .map-option-btn:hover {
            border-color: var(--mw-orange);
        }

        .map-option-btn.active {
            background: var(--mw-orange);
            border-color: var(--mw-orange);
            color: var(--mw-white);
        }

        .map-option-btn .icon {
            font-size: 14px;
        }

        /* Scrollbar styling */
        .rep-list::-webkit-scrollbar,
        .legend::-webkit-scrollbar {
            width: 6px;
        }

        .rep-list::-webkit-scrollbar-track,
        .legend::-webkit-scrollbar-track {
            background: var(--mw-gray-light);
        }

        .rep-list::-webkit-scrollbar-thumb,
        .legend::-webkit-scrollbar-thumb {
            background: var(--mw-gray);
            border-radius: 3px;
        }

        .rep-list::-webkit-scrollbar-thumb:hover,
        .legend::-webkit-scrollbar-thumb:hover {
            background: var(--mw-gray-dark);
        }

        /* Split Mode Styles */
        .split-mode-banner {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: var(--mw-orange);
            color: var(--mw-white);
            padding: 12px 20px;
            text-align: center;
            font-weight: 600;
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .split-mode-banner.visible {
            display: flex;
        }

        .split-mode-banner .instructions {
            font-size: 14px;
        }

        .split-mode-banner .cancel-btn {
            background: var(--mw-white);
            color: var(--mw-orange);
            border: none;
            padding: 6px 14px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
        }

        .split-mode-banner .cancel-btn:hover {
            background: var(--mw-gray-light);
        }

        .split-line-preview {
            stroke: var(--mw-orange);
            stroke-width: 3;
            stroke-dasharray: 8, 4;
            pointer-events: none;
        }

        .split-point {
            fill: var(--mw-orange);
            stroke: var(--mw-white);
            stroke-width: 2;
            cursor: pointer;
        }

        .county.split-target {
            stroke: var(--mw-orange) !important;
            stroke-width: 3px !important;
            stroke-dasharray: 5, 3;
        }

        .county.multi-selected {
            stroke: var(--mw-orange) !important;
            stroke-width: 3px !important;
            filter: brightness(1.1);
        }

        /* Multi-Select Action Bar */
        .multi-select-bar {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--mw-navy);
            color: var(--mw-white);
            padding: 12px 20px;
            border-radius: 8px;
            display: none;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 100;
        }

        .multi-select-bar.visible {
            display: flex;
        }

        .multi-select-bar .count {
            font-weight: 600;
            color: var(--mw-orange);
        }

        .multi-select-bar select {
            padding: 6px 10px;
            border-radius: 4px;
            border: none;
            font-size: 14px;
        }

        .multi-select-bar .btn {
            padding: 6px 12px;
            font-size: 14px;
        }

        .multi-select-bar .btn-clear {
            background: transparent;
            border: 1px solid var(--mw-white);
            color: var(--mw-white);
        }

        .multi-select-bar .btn-clear:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .split-county-half {
            stroke: var(--mw-white);
            stroke-width: 1px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .split-county-half:hover {
            opacity: 0.85;
            stroke: var(--mw-navy);
            stroke-width: 2px;
        }

        .split-divider {
            stroke: var(--mw-white);
            stroke-width: 2px;
            pointer-events: none;
        }

        /* Modal split section */
        .modal-split-section {
            border-top: 1px solid var(--mw-gray);
            margin-top: 16px;
            padding-top: 16px;
        }

        .modal-split-section p {
            font-size: 13px;
            color: var(--mw-gray-dark);
            margin-bottom: 12px;
        }

        .btn-split {
            background: var(--mw-orange);
            color: var(--mw-white);
            width: 100%;
        }

        .btn-split:hover {
            background: var(--mw-orange-hover);
        }

        /* Split assignment modal */
        .split-rep-select {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }

        .split-rep-select label {
            font-size: 12px;
            font-weight: 600;
            color: var(--mw-navy);
            text-transform: uppercase;
            margin-bottom: 6px;
            display: block;
        }

        .split-rep-select select {
            margin-bottom: 0;
        }

        .split-rep-select input[type="number"] {
            width: 100%;
            padding: 8px 10px;
            border: 2px solid var(--mw-gray);
            border-radius: 4px;
            font-size: 14px;
            margin-top: 8px;
        }

        .split-rep-select input[type="number"]:focus {
            outline: none;
            border-color: var(--mw-orange);
        }

        .split-rep-select .price-label {
            font-size: 11px;
            color: var(--mw-gray-dark);
            margin-top: 8px;
            display: block;
        }

        /* Custom Color Picker in Modal */
        .color-option {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .color-option label {
            font-size: 13px;
            color: var(--mw-gray-dark);
        }

        .color-option input[type="color"] {
            width: 44px;
            height: 36px;
            border: 2px solid var(--mw-gray);
            border-radius: 4px;
            cursor: pointer;
            padding: 3px;
        }

        .color-option input[type="color"]:focus {
            outline: none;
            border-color: var(--mw-orange);
        }

        /* Price Adjustment Input */
        .price-option {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .price-option label {
            font-size: 13px;
            color: var(--mw-gray-dark);
        }

        .price-option input[type="number"] {
            width: 100px;
            padding: 8px 10px;
            border: 2px solid var(--mw-gray);
            border-radius: 4px;
            font-size: 14px;
        }

        .price-option input[type="number"]:focus {
            outline: none;
            border-color: var(--mw-orange);
        }

        .price-option .price-hint {
            font-size: 11px;
            color: var(--mw-gray-dark);
            font-style: italic;
        }

        /* Multi-select bar color picker */
        .multi-select-bar input[type="color"] {
            width: 36px;
            height: 32px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            cursor: pointer;
            padding: 2px;
        }

        .multi-select-bar input[type="number"] {
            width: 80px;
            padding: 6px 8px;
            border-radius: 4px;
            border: none;
            font-size: 14px;
        }

        .multi-select-bar .price-label {
            font-size: 12px;
            color: rgba(255,255,255,0.8);
        }

        /* City Markers */
        .city-dot {
            fill: var(--mw-navy);
            stroke: var(--mw-white);
            stroke-width: 1px;
        }

        .city-label {
            font-size: 7px;
            fill: var(--mw-navy);
            pointer-events: none;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <button class="sidebar-toggle" id="sidebarToggle" title="Toggle Sidebar">&#9664;</button>
            <!-- State Tabs -->
            <div class="state-tabs">
                <button class="state-tab active" data-state="NC">NC</button>
                <button class="state-tab" data-state="SC">SC</button>
            </div>
            <div class="sidebar-header">
                <h1>Sales Territory Map</h1>
                <div class="subtitle" id="stateSubtitle">North Carolina</div>
                <div class="hint">Tip: Cmd/Ctrl+click to select multiple counties</div>
            </div>

            <!-- Add Zone -->
            <div class="sidebar-section">
                <h2>Add Zone</h2>
                <div class="add-zone-form">
                    <div class="add-zone-row">
                        <input type="text" id="repName" placeholder="Zone name...">
                        <button class="btn btn-primary" onclick="addSalesRep()">Add</button>
                    </div>
                    <div class="add-zone-row">
                        <label>Color:</label>
                        <input type="color" id="repColor" value="#f7941d">
                        <label>Price: $</label>
                        <input type="number" id="repPrice" placeholder="0" title="Price adjustment">
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="sidebar-section">
                <h2>Statistics</h2>
                <div class="stats-grid">
                    <div class="stat-card highlight">
                        <div class="stat-value" id="totalReps">0</div>
                        <div class="stat-label">Zones</div>
                    </div>
                    <div class="stat-card highlight">
                        <div class="stat-value" id="assignedCounties">0</div>
                        <div class="stat-label">Assigned</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="unassignedCounties">100</div>
                        <div class="stat-label">Unassigned</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalCounties">100</div>
                        <div class="stat-label">Total Counties</div>
                    </div>
                </div>
            </div>

            <!-- Zone List -->
            <div class="sidebar-section" style="flex: 1; display: flex; flex-direction: column; overflow: hidden; padding-bottom: 0;">
                <h2>Zones</h2>
                <div class="rep-list" id="repList">
                    <!-- Populated dynamically -->
                </div>
            </div>
        </div>

        <!-- Map -->
        <div class="map-container">
            <div class="split-mode-banner" id="splitModeBanner">
                <span class="instructions">Click two points on the county boundary to draw a split line</span>
                <button class="cancel-btn" onclick="cancelSplitMode()">Cancel</button>
            </div>
            <div class="zoom-controls">
                <button class="zoom-btn" onclick="zoomIn()">+</button>
                <button class="zoom-btn" onclick="zoomOut()">−</button>
                <button class="zoom-btn" onclick="resetZoom()">⟲</button>
            </div>
            <div class="map-options">
                <button class="map-option-btn active" id="toggleCities" onclick="toggleCityLabels()" title="Toggle city labels">
                    <span class="icon">&#9679;</span> Cities
                </button>
            </div>
            <button class="btn btn-secondary export-btn" onclick="exportMap()">Export as Image</button>
            <div id="map"></div>
            <div class="tooltip" id="tooltip"></div>
            <!-- Multi-Select Action Bar -->
            <div class="multi-select-bar" id="multiSelectBar">
                <span><span class="count" id="multiSelectCount">0</span> counties selected</span>
                <select id="multiSelectRep">
                    <option value="">-- Assign to Zone --</option>
                </select>
                <input type="color" id="multiSelectColor" value="#f7941d" title="Custom Color">
                <button class="btn btn-primary" onclick="assignSelectedCounties()">Assign</button>
                <button class="btn btn-secondary" onclick="unassignSelectedCounties()">Unassign</button>
                <button class="btn btn-clear" onclick="clearSelection()">Clear</button>
            </div>
            <div class="legend" id="legend">
                <div class="legend-header">
                    <h3>Legend</h3>
                    <button class="legend-close" id="legendClose" title="Hide Legend">&times;</button>
                </div>
                <div id="legendItems"></div>
            </div>
            <button class="legend-show-btn" id="legendShowBtn">Show Legend</button>
        </div>
    </div>

    <!-- Assignment Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">Assign County</h3>
            </div>
            <div class="modal-body">
                <select id="repSelect">
                    <option value="">-- Select Zone --</option>
                </select>
                <div class="color-option">
                    <label>Custom Color:</label>
                    <input type="color" id="countyColorPicker" value="#f7941d">
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-danger" onclick="unassignCounty()">Unassign</button>
                    <button class="btn btn-primary" onclick="assignCounty()">Assign</button>
                </div>
                <div class="modal-create-zone">
                    <div class="create-zone-header" onclick="toggleCreateZoneSection()">
                        <span>Or create new zone</span>
                        <span class="expand-icon" id="createZoneExpandIcon">+</span>
                    </div>
                    <div class="create-zone-form" id="createZoneForm" style="display: none;">
                        <input type="text" id="modalZoneName" placeholder="Zone name...">
                        <div class="create-zone-row">
                            <label>Color:</label>
                            <input type="color" id="modalZoneColor" value="#f7941d">
                            <label>Price: $</label>
                            <input type="number" id="modalZonePrice" placeholder="0">
                        </div>
                        <button class="btn btn-primary" onclick="createAndAssignZone()">Create & Assign</button>
                    </div>
                </div>
                <div class="modal-split-section" id="splitSection" style="display: none;">
                    <p>This county is already assigned. Split it between two zones?</p>
                    <button class="btn btn-split" onclick="startSplitMode()">Split County</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Split Assignment Modal -->
    <div class="modal-overlay" id="splitModalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h3 id="splitModalTitle">Assign Split Regions</h3>
            </div>
            <div class="modal-body">
                <div class="split-rep-select">
                    <div>
                        <label>Side 1 (highlighted)</label>
                        <select id="splitRep1">
                            <option value="">-- Select Zone --</option>
                        </select>
                    </div>
                    <div>
                        <label>Side 2</label>
                        <select id="splitRep2">
                            <option value="">-- Select Zone --</option>
                        </select>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="cancelSplitAssignment()">Cancel</button>
                    <button class="btn btn-primary" onclick="confirmSplitAssignment()">Confirm Split</button>
                </div>
            </div>
        </div>
    </div>

    <script src="nc-counties.js"></script>
    <script src="nc-cities.js"></script>
    <script src="sc-counties.js"></script>
    <script src="sc-cities.js"></script>
    <script>
        // State Configuration
        const STATE_CONFIG = {
            NC: {
                name: 'North Carolina',
                abbr: 'NC',
                center: [-79.5, 35.5],
                scale: 6000,
                counties: () => ncCountiesGeoJSON,
                cities: () => ncCitiesGeoJSON,
                storagePrefix: 'nc-territory'
            },
            SC: {
                name: 'South Carolina',
                abbr: 'SC',
                center: [-80.9, 33.8],
                scale: 7000,
                counties: () => scCountiesGeoJSON,
                cities: () => scCitiesGeoJSON,
                storagePrefix: 'sc-territory'
            }
        };

        let currentState = 'NC';

        // State
        let salesReps = [];
        let assignments = {}; // countyId -> repId OR { split: true, line: [...], rep1: id, rep2: id }
        let selectedCounty = null;

        // Split Mode State
        let splitMode = false;
        let splitCountyId = null;
        let splitCountyFeature = null;
        let splitPoints = [];
        let splitLinePreview = null;
        let splitPolygons = null;

        // Multi-Select State
        let selectedCounties = new Set(); // Set of county GEOIDs

        // Modal Update State (prevents event listeners from overwriting colors during programmatic updates)
        let isUpdatingModal = false;

        // D3 Variables
        let svg, g, projection, path, zoom;
        const width = 900;
        const height = 600;

        // Security: HTML escaping to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Security: Validate hex color format
        function sanitizeColor(color) {
            if (/^#[0-9A-Fa-f]{6}$/.test(color)) {
                return color;
            }
            return '#f7941d';
        }

        // Format price adjustment for display
        function formatPriceAdjustment(price) {
            if (price === null || price === undefined || price === 0) return null;
            const num = parseFloat(price);
            if (isNaN(num)) return null;
            if (num > 0) return `+$${num.toFixed(0)}`;
            return `-$${Math.abs(num).toFixed(0)}`;
        }

        // Get price class for styling
        function getPriceClass(price) {
            if (price === null || price === undefined || price === 0) return '';
            const num = parseFloat(price);
            if (isNaN(num)) return '';
            return num > 0 ? 'positive' : 'negative';
        }

        // Basic color name to hex mapping
        const colorNameMap = {
            'red': '#e74c3c',
            'blue': '#3498db',
            'green': '#27ae60',
            'yellow': '#f1c40f',
            'orange': '#f39c12',
            'purple': '#9b59b6',
            'pink': '#e91e63',
            'brown': '#795548',
            'gray': '#95a5a6',
            'grey': '#95a5a6',
            'black': '#2c3e50',
            'white': '#ecf0f1'
        };

        // Get color from zone name if it matches a basic color
        function getColorFromName(name) {
            const lowerName = name.toLowerCase().trim();
            return colorNameMap[lowerName] || null;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initTabs();
            loadFromLocalStorage();
            initMap();
            renderRepList();
            updateStats();
            updateLegend();
        });

        // Tab Navigation
        function initTabs() {
            document.querySelectorAll('.state-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const newState = tab.dataset.state;
                    if (newState !== currentState) {
                        switchState(newState);
                    }
                });
            });
        }

        function switchState(newState) {
            // Cancel split mode if active
            if (splitMode) {
                cancelSplitMode();
            }

            // Clear multi-select
            selectedCounties.clear();

            // Update current state
            currentState = newState;

            // Update tab UI
            document.querySelectorAll('.state-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.state === newState);
            });

            // Update subtitle
            document.getElementById('stateSubtitle').textContent = STATE_CONFIG[newState].name;

            // Load data for new state
            loadFromLocalStorage();

            // Update projection for new state
            const config = STATE_CONFIG[newState];
            projection
                .center(config.center)
                .scale(config.scale);
            path = d3.geoPath().projection(projection);

            // Redraw everything
            redrawMap();
            renderRepList();
            updateStats();
            updateLegend();

            // Reset zoom
            svg.transition().duration(300).call(zoom.transform, d3.zoomIdentity);
        }

        // Local Storage
        function getStorageKey(suffix) {
            return `${STATE_CONFIG[currentState].storagePrefix}-${suffix}`;
        }

        function saveToLocalStorage() {
            localStorage.setItem(getStorageKey('reps'), JSON.stringify(salesReps));
            localStorage.setItem(getStorageKey('assignments'), JSON.stringify(assignments));
        }

        function loadFromLocalStorage() {
            try {
                const reps = localStorage.getItem(getStorageKey('reps'));
                const assigns = localStorage.getItem(getStorageKey('assignments'));

                if (reps) {
                    const parsed = JSON.parse(reps);
                    if (Array.isArray(parsed)) {
                        salesReps = parsed.filter(r => r && r.id && r.name && r.color);
                    }
                } else {
                    salesReps = [];
                }
                if (assigns) {
                    const parsed = JSON.parse(assigns);
                    if (typeof parsed === 'object' && parsed !== null) {
                        assignments = parsed;
                    }
                } else {
                    assignments = {};
                }
            } catch (e) {
                console.error('Failed to load from localStorage:', e);
                salesReps = [];
                assignments = {};
            }
        }

        // Check if assignment is a split
        function isSplitAssignment(assignment) {
            return assignment && typeof assignment === 'object' && assignment.split === true;
        }

        // Map Initialization
        function initMap() {
            const container = document.getElementById('map');

            svg = d3.select('#map')
                .append('svg')
                .attr('width', '100%')
                .attr('height', '100%')
                .attr('viewBox', `0 0 ${width} ${height}`);

            // Create zoom behavior
            zoom = d3.zoom()
                .scaleExtent([1, 8])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                });

            svg.call(zoom);

            g = svg.append('g');

            // Setup projection centered on current state
            const config = STATE_CONFIG[currentState];
            projection = d3.geoMercator()
                .center(config.center)
                .scale(config.scale)
                .translate([width / 2, height / 2]);

            path = d3.geoPath().projection(projection);

            // Draw counties
            drawCounties();

            // Add click handler for split mode
            svg.on('click', handleSvgClick);
        }

        function drawCounties() {
            const countiesData = STATE_CONFIG[currentState].counties();
            // Draw regular (non-split) counties
            countiesData.features.forEach(feature => {
                const countyId = feature.properties.GEOID;
                const assignment = assignments[countyId];

                if (isSplitAssignment(assignment)) {
                    drawSplitCounty(feature, assignment);
                } else {
                    drawRegularCounty(feature);
                }
            });

            // Add county labels
            g.selectAll('.county-label')
                .data(countiesData.features)
                .enter()
                .append('text')
                .attr('class', 'county-label')
                .attr('transform', d => `translate(${path.centroid(d)})`)
                .text(d => d.properties.NAME);

            // Draw cities on top of counties
            drawCities();
        }

        function drawCities() {
            const citiesData = STATE_CONFIG[currentState].cities();
            // Draw city dots
            g.selectAll('.city-dot')
                .data(citiesData.features)
                .enter()
                .append('circle')
                .attr('class', 'city-dot')
                .attr('cx', d => projection(d.geometry.coordinates)[0])
                .attr('cy', d => projection(d.geometry.coordinates)[1])
                .attr('r', 4)
                .on('mouseover', (event, d) => showCityTooltip(event, d.properties))
                .on('mousemove', (event) => moveTooltip(event))
                .on('mouseout', hideTooltip);

            // Draw city labels
            g.selectAll('.city-label')
                .data(citiesData.features)
                .enter()
                .append('text')
                .attr('class', 'city-label')
                .attr('x', d => projection(d.geometry.coordinates)[0] + 6)
                .attr('y', d => projection(d.geometry.coordinates)[1] + 3)
                .text(d => d.properties.name);
        }

        function showCityTooltip(event, properties) {
            const tooltip = document.getElementById('tooltip');
            const population = properties.population.toLocaleString();

            tooltip.innerHTML = `
                <div class="tooltip-title">${escapeHtml(properties.name)}</div>
                <div class="tooltip-rep">Population: ${population}</div>
            `;
            tooltip.classList.add('visible');
            moveTooltip(event);
        }

        let citiesVisible = true;

        function toggleCityLabels() {
            citiesVisible = !citiesVisible;
            const btn = document.getElementById('toggleCities');
            btn.classList.toggle('active', citiesVisible);

            g.selectAll('.city-label').style('display', citiesVisible ? null : 'none');
            g.selectAll('.city-dot').style('display', citiesVisible ? null : 'none');
        }

        function drawRegularCounty(feature) {
            const countyId = feature.properties.GEOID;
            const assignment = assignments[countyId];

            g.append('path')
                .datum(feature)
                .attr('class', `county ${assignment ? '' : 'unassigned'} ${selectedCounties.has(countyId) ? 'multi-selected' : ''}`)
                .attr('d', path)
                .attr('fill', getCountyColor(countyId))
                .attr('data-id', countyId)
                .on('click', (event, d) => {
                    if (splitMode) return;

                    // Check for Cmd (Mac) or Ctrl (Windows/Linux) key
                    if (event.metaKey || event.ctrlKey) {
                        toggleCountySelection(d.properties.GEOID);
                    } else {
                        // Regular click - clear selection and open modal
                        if (selectedCounties.size > 0) {
                            clearSelection();
                        }
                        openModal(d.properties);
                    }
                })
                .on('mouseover', (event, d) => showTooltip(event, d.properties))
                .on('mousemove', (event) => moveTooltip(event))
                .on('mouseout', hideTooltip);
        }

        function drawSplitCounty(feature, assignment) {
            const countyId = feature.properties.GEOID;
            const clipId = `clip-${countyId}`;

            try {
                // Create a clip path using the original county boundary (the master copy)
                // This ensures all fills stay strictly within the county borders
                let defs = svg.select('defs');
                if (defs.empty()) {
                    defs = svg.insert('defs', ':first-child');
                }

                // Remove any existing clip path for this county
                defs.select(`#${clipId}`).remove();

                // Create clip path from the original county boundary
                const clipPath = defs.append('clipPath')
                    .attr('id', clipId);

                clipPath.append('path')
                    .datum(feature)
                    .attr('d', path);

                // Get the line coordinates in screen space
                const lineCoords = assignment.line.map(coord => projection(coord));

                // Calculate the bounding box of the county in screen space
                const bounds = path.bounds(feature);
                const padding = 1000; // Large padding to ensure full coverage

                // Calculate line direction and perpendicular
                const dx = lineCoords[1][0] - lineCoords[0][0];
                const dy = lineCoords[1][1] - lineCoords[0][1];
                const len = Math.sqrt(dx * dx + dy * dy);
                const unitX = dx / len;
                const unitY = dy / len;
                const perpX = -unitY;
                const perpY = unitX;

                // Extend the line far beyond the county
                const extendedP1 = [
                    lineCoords[0][0] - unitX * padding,
                    lineCoords[0][1] - unitY * padding
                ];
                const extendedP2 = [
                    lineCoords[1][0] + unitX * padding,
                    lineCoords[1][1] + unitY * padding
                ];

                // Create a group that will be clipped to the county boundary
                const splitGroup = g.append('g')
                    .attr('class', 'split-county-group')
                    .attr('data-id', countyId)
                    .attr('clip-path', `url(#${clipId})`);

                // Draw side 1: a large polygon on one side of the line
                const rep1 = salesReps.find(r => r.id === assignment.rep1);
                const side1Points = [
                    extendedP1,
                    extendedP2,
                    [extendedP2[0] + perpX * padding, extendedP2[1] + perpY * padding],
                    [extendedP1[0] + perpX * padding, extendedP1[1] + perpY * padding]
                ];

                splitGroup.append('polygon')
                    .attr('class', 'split-county-half')
                    .attr('points', side1Points.map(p => p.join(',')).join(' '))
                    .attr('fill', rep1 ? rep1.color : '#d0d8e0')
                    .attr('data-id', countyId)
                    .attr('data-side', '1')
                    .on('click', () => {
                        if (!splitMode) openSplitModal(feature.properties, assignment);
                    })
                    .on('mouseover', (event) => showSplitTooltip(event, feature.properties, assignment, 1))
                    .on('mousemove', (event) => moveTooltip(event))
                    .on('mouseout', hideTooltip);

                // Draw side 2: a large polygon on the other side of the line
                const rep2 = salesReps.find(r => r.id === assignment.rep2);
                const side2Points = [
                    extendedP1,
                    extendedP2,
                    [extendedP2[0] - perpX * padding, extendedP2[1] - perpY * padding],
                    [extendedP1[0] - perpX * padding, extendedP1[1] - perpY * padding]
                ];

                splitGroup.append('polygon')
                    .attr('class', 'split-county-half')
                    .attr('points', side2Points.map(p => p.join(',')).join(' '))
                    .attr('fill', rep2 ? rep2.color : '#d0d8e0')
                    .attr('data-id', countyId)
                    .attr('data-side', '2')
                    .on('click', () => {
                        if (!splitMode) openSplitModal(feature.properties, assignment);
                    })
                    .on('mouseover', (event) => showSplitTooltip(event, feature.properties, assignment, 2))
                    .on('mousemove', (event) => moveTooltip(event))
                    .on('mouseout', hideTooltip);

                // Draw the county border on top
                splitGroup.append('path')
                    .datum(feature)
                    .attr('class', 'split-county-border')
                    .attr('d', path)
                    .attr('fill', 'none')
                    .attr('stroke', '#1a2a3a')
                    .attr('stroke-width', '1px');

                // Draw the dividing line
                g.append('line')
                    .attr('class', 'split-divider')
                    .attr('x1', lineCoords[0][0])
                    .attr('y1', lineCoords[0][1])
                    .attr('x2', lineCoords[1][0])
                    .attr('y2', lineCoords[1][1])
                    .attr('data-id', countyId);

            } catch (e) {
                console.error('Error drawing split county:', countyId, e);
                // Fall back to regular drawing
                drawRegularCounty(feature);
            }
        }

        function getCountyColor(countyId) {
            const assignment = assignments[countyId];
            if (!assignment) return '#d0d8e0';
            if (isSplitAssignment(assignment)) {
                return '#d0d8e0'; // Split counties are drawn separately
            }
            // Check for new object format with custom color
            if (typeof assignment === 'object' && assignment.repId) {
                // Custom color takes priority if present
                if (assignment.color) {
                    return sanitizeColor(assignment.color);
                }
                const rep = salesReps.find(r => r.id === assignment.repId);
                return rep ? rep.color : '#d0d8e0';
            }
            // Legacy format: assignment is just the repId string
            const rep = salesReps.find(r => r.id === assignment);
            return rep ? rep.color : '#d0d8e0';
        }

        function redrawMap() {
            // Clear and redraw all counties
            g.selectAll('.county').remove();
            g.selectAll('.split-county-half').remove();
            g.selectAll('.split-county-group').remove();
            g.selectAll('.split-county-border').remove();
            g.selectAll('.split-divider').remove();
            g.selectAll('.county-label').remove();
            g.selectAll('.split-point').remove();
            g.selectAll('.split-line-preview').remove();
            g.selectAll('.city-dot').remove();
            g.selectAll('.city-label').remove();

            // Clean up clip paths
            svg.selectAll('defs clipPath[id^="clip-"]').remove();

            drawCounties();

            // Restore city visibility state
            if (!citiesVisible) {
                g.selectAll('.city-label').style('display', 'none');
                g.selectAll('.city-dot').style('display', 'none');
            }
        }

        // Zoom Controls
        function zoomIn() {
            svg.transition().call(zoom.scaleBy, 1.5);
        }

        function zoomOut() {
            svg.transition().call(zoom.scaleBy, 0.67);
        }

        function resetZoom() {
            svg.transition().call(zoom.transform, d3.zoomIdentity);
        }

        // Tooltip
        function showTooltip(event, properties) {
            const tooltip = document.getElementById('tooltip');
            const countyId = properties.GEOID;
            const assignment = assignments[countyId];

            let repText = 'Unassigned';
            let priceText = '';
            if (isSplitAssignment(assignment)) {
                const rep1 = salesReps.find(r => r.id === assignment.rep1);
                const rep2 = salesReps.find(r => r.id === assignment.rep2);
                repText = `Split: ${rep1 ? escapeHtml(rep1.name) : '?'} / ${rep2 ? escapeHtml(rep2.name) : '?'}`;
                // Show zone prices for split counties
                const price1 = rep1 && rep1.price ? formatPriceAdjustment(rep1.price) : null;
                const price2 = rep2 && rep2.price ? formatPriceAdjustment(rep2.price) : null;
                if (price1 || price2) {
                    const parts = [];
                    if (price1) parts.push(`${escapeHtml(rep1.name)}: ${price1}`);
                    if (price2) parts.push(`${escapeHtml(rep2.name)}: ${price2}`);
                    priceText = `<div style="margin-top:4px;font-size:12px;">${parts.join(' | ')}</div>`;
                }
            } else if (assignment) {
                // Handle both new object format and legacy string format
                const repId = typeof assignment === 'object' ? assignment.repId : assignment;
                const rep = salesReps.find(r => r.id === repId);
                repText = rep ? `Assigned to: ${escapeHtml(rep.name)}` : 'Unassigned';
                // Show zone price
                if (rep && rep.price) {
                    const priceFormatted = formatPriceAdjustment(rep.price);
                    const priceClass = getPriceClass(rep.price);
                    priceText = `<div style="margin-top:4px;font-size:12px;" class="price-value ${priceClass}">Price: ${priceFormatted}</div>`;
                }
            }

            tooltip.innerHTML = `
                <div class="tooltip-title">${escapeHtml(properties.NAME)} County</div>
                <div class="tooltip-rep">${repText}</div>
                ${priceText}
            `;
            tooltip.classList.add('visible');
            moveTooltip(event);
        }

        function showSplitTooltip(event, properties, assignment, side) {
            const tooltip = document.getElementById('tooltip');
            const repId = side === 1 ? assignment.rep1 : assignment.rep2;
            const rep = salesReps.find(r => r.id === repId);
            let priceText = '';
            if (rep && rep.price) {
                const priceFormatted = formatPriceAdjustment(rep.price);
                const priceClass = getPriceClass(rep.price);
                priceText = `<div style="margin-top:4px;font-size:12px;" class="price-value ${priceClass}">Price: ${priceFormatted}</div>`;
            }

            tooltip.innerHTML = `
                <div class="tooltip-title">${escapeHtml(properties.NAME)} County (Side ${side})</div>
                <div class="tooltip-rep">${rep ? escapeHtml(rep.name) : 'Unassigned'}</div>
                ${priceText}
            `;
            tooltip.classList.add('visible');
            moveTooltip(event);
        }

        function moveTooltip(event) {
            const tooltip = document.getElementById('tooltip');
            const container = document.querySelector('.map-container');
            const rect = container.getBoundingClientRect();
            tooltip.style.left = (event.clientX - rect.left + 15) + 'px';
            tooltip.style.top = (event.clientY - rect.top + 15) + 'px';
        }

        function hideTooltip() {
            document.getElementById('tooltip').classList.remove('visible');
        }

        // Modal
        function openModal(properties) {
            if (splitMode) return;

            // Prevent event listeners from overwriting colors during setup
            isUpdatingModal = true;

            selectedCounty = properties;
            document.getElementById('modalTitle').textContent = `Assign ${properties.NAME} County`;

            const select = document.getElementById('repSelect');
            select.innerHTML = '<option value="">-- Select Zone --</option>';

            const currentAssignment = assignments[properties.GEOID];
            const isCurrentlySplit = isSplitAssignment(currentAssignment);

            // Determine current repId (handles both old string format and new object format)
            let currentRepId = null;
            let currentCustomColor = null;
            if (currentAssignment && !isCurrentlySplit) {
                if (typeof currentAssignment === 'object' && currentAssignment.repId) {
                    currentRepId = currentAssignment.repId;
                    currentCustomColor = currentAssignment.color;
                } else if (typeof currentAssignment === 'string') {
                    currentRepId = currentAssignment;
                }
            }

            salesReps.forEach(rep => {
                const option = document.createElement('option');
                option.value = rep.id;
                option.textContent = rep.name;
                if (currentRepId === rep.id) {
                    option.selected = true;
                }
                select.appendChild(option);
            });

            // Set color picker to existing custom color or default
            const colorPicker = document.getElementById('countyColorPicker');
            if (currentCustomColor) {
                colorPicker.value = currentCustomColor;
            } else if (currentRepId) {
                const rep = salesReps.find(r => r.id === currentRepId);
                colorPicker.value = rep ? rep.color : '#f7941d';
            } else {
                colorPicker.value = '#f7941d';
            }

            // Show split section if county is already assigned (not split)
            const splitSection = document.getElementById('splitSection');
            if (currentAssignment && !isCurrentlySplit && salesReps.length >= 2) {
                splitSection.style.display = 'block';
            } else {
                splitSection.style.display = 'none';
            }

            // Reset create zone form
            document.getElementById('createZoneForm').style.display = 'none';
            document.getElementById('createZoneExpandIcon').textContent = '+';
            document.getElementById('modalZoneName').value = '';
            document.getElementById('modalZoneColor').value = getRandomColor();
            document.getElementById('modalZonePrice').value = '';

            document.getElementById('modalOverlay').classList.add('visible');

            // Re-enable event listeners
            isUpdatingModal = false;
        }

        function openSplitModal(properties, assignment) {
            selectedCounty = properties;
            document.getElementById('modalTitle').textContent = `Manage ${properties.NAME} County (Split)`;

            const select = document.getElementById('repSelect');
            select.innerHTML = '<option value="">-- Reassign Entire County to Zone --</option>';
            salesReps.forEach(rep => {
                const option = document.createElement('option');
                option.value = rep.id;
                option.textContent = rep.name;
                select.appendChild(option);
            });

            // Hide split section for already split counties
            document.getElementById('splitSection').style.display = 'none';

            document.getElementById('modalOverlay').classList.add('visible');
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('visible');
            selectedCounty = null;
        }

        // Multi-Select Functions
        function toggleCountySelection(countyId) {
            if (selectedCounties.has(countyId)) {
                selectedCounties.delete(countyId);
            } else {
                selectedCounties.add(countyId);
            }
            updateMultiSelectUI();
            updateCountySelectionVisuals();
        }

        function updateCountySelectionVisuals() {
            // Update visual state of all counties
            g.selectAll('.county').each(function() {
                const el = d3.select(this);
                const countyId = el.attr('data-id');
                el.classed('multi-selected', selectedCounties.has(countyId));
            });
        }

        function updateMultiSelectUI() {
            const bar = document.getElementById('multiSelectBar');
            const countEl = document.getElementById('multiSelectCount');
            const select = document.getElementById('multiSelectRep');

            if (selectedCounties.size > 0) {
                bar.classList.add('visible');
                countEl.textContent = selectedCounties.size;

                // Update zone dropdown
                select.innerHTML = '<option value="">-- Assign to Zone --</option>';
                salesReps.forEach(rep => {
                    const option = document.createElement('option');
                    option.value = rep.id;
                    option.textContent = rep.name;
                    select.appendChild(option);
                });
            } else {
                bar.classList.remove('visible');
            }
        }

        function assignSelectedCounties() {
            const repId = document.getElementById('multiSelectRep').value;
            const customColor = document.getElementById('multiSelectColor').value;

            if (!repId) {
                alert('Please select a zone');
                return;
            }

            // Get the rep's default color to compare
            const rep = salesReps.find(r => r.id === repId);
            const repDefaultColor = rep ? rep.color : '#f7941d';

            // Determine if we need the object format
            const hasCustomColor = customColor && customColor !== repDefaultColor;

            // Assign all selected counties to the rep with optional custom color
            selectedCounties.forEach(countyId => {
                if (hasCustomColor) {
                    assignments[countyId] = {
                        repId: repId,
                        color: sanitizeColor(customColor)
                    };
                } else {
                    assignments[countyId] = repId;
                }
            });

            saveToLocalStorage();
            clearSelection();
            redrawMap();
            updateStats();
            renderRepList();
            updateLegend();
        }

        function clearSelection() {
            selectedCounties.clear();
            updateMultiSelectUI();
            updateCountySelectionVisuals();
        }

        function unassignSelectedCounties() {
            selectedCounties.forEach(countyId => {
                delete assignments[countyId];
            });

            saveToLocalStorage();
            clearSelection();
            redrawMap();
            updateStats();
            renderRepList();
            updateLegend();
        }

        function assignCounty() {
            const repId = document.getElementById('repSelect').value;
            const customColor = document.getElementById('countyColorPicker').value;

            if (!repId || !selectedCounty) {
                closeModal();
                return;
            }

            // Get the rep's default color to compare
            const rep = salesReps.find(r => r.id === repId);
            const repDefaultColor = rep ? rep.color : '#f7941d';

            // This overwrites any existing assignment (including splits)
            // Determine if we need the object format (custom color)
            const hasCustomColor = customColor && customColor !== repDefaultColor;

            if (hasCustomColor) {
                assignments[selectedCounty.GEOID] = {
                    repId: repId,
                    color: sanitizeColor(customColor)
                };
            } else {
                assignments[selectedCounty.GEOID] = repId;
            }
            saveToLocalStorage();
            redrawMap();
            updateStats();
            renderRepList();
            updateLegend();
            closeModal();
        }

        function unassignCounty() {
            if (!selectedCounty) {
                closeModal();
                return;
            }

            delete assignments[selectedCounty.GEOID];
            saveToLocalStorage();
            redrawMap();
            updateStats();
            renderRepList();
            updateLegend();
            closeModal();
        }

        // Split Mode Functions
        function startSplitMode() {
            if (!selectedCounty || salesReps.length < 2) return;

            splitMode = true;
            splitCountyId = selectedCounty.GEOID;
            splitCountyFeature = STATE_CONFIG[currentState].counties().features.find(
                f => f.properties.GEOID === splitCountyId
            );
            splitPoints = [];

            closeModal();

            // Show banner
            document.getElementById('splitModeBanner').classList.add('visible');

            // Highlight target county
            g.selectAll('.county')
                .filter(function() {
                    return d3.select(this).attr('data-id') === splitCountyId;
                })
                .classed('split-target', true);

            // Disable zoom during split mode
            svg.on('.zoom', null);
        }

        function cancelSplitMode() {
            splitMode = false;
            splitCountyId = null;
            splitCountyFeature = null;
            splitPoints = [];
            splitPolygons = null;

            document.getElementById('splitModeBanner').classList.remove('visible');

            // Remove split UI elements
            g.selectAll('.split-point').remove();
            g.selectAll('.split-line-preview').remove();
            g.selectAll('.county').classed('split-target', false);

            // Re-enable zoom
            svg.call(zoom);
        }

        function handleSvgClick(event) {
            if (!splitMode || !splitCountyFeature) return;

            // Get click position in geographic coordinates
            const [mx, my] = d3.pointer(event, g.node());
            const geoCoord = projection.invert([mx, my]);

            // Check if click is inside the target county
            const point = turf.point(geoCoord);
            if (!turf.booleanPointInPolygon(point, splitCountyFeature)) {
                return; // Click outside county
            }

            splitPoints.push(geoCoord);

            // Draw point marker
            g.append('circle')
                .attr('class', 'split-point')
                .attr('cx', mx)
                .attr('cy', my)
                .attr('r', 6);

            if (splitPoints.length === 1) {
                // Update instructions
                document.querySelector('.split-mode-banner .instructions').textContent =
                    'Click second point to complete the split line';
            } else if (splitPoints.length === 2) {
                // Draw preview line
                const p1 = projection(splitPoints[0]);
                const p2 = projection(splitPoints[1]);

                g.append('line')
                    .attr('class', 'split-line-preview')
                    .attr('x1', p1[0])
                    .attr('y1', p1[1])
                    .attr('x2', p2[0])
                    .attr('y2', p2[1]);

                // With SVG clip paths, we don't need to pre-compute polygons
                // The line will be used directly to render the split visually
                // Show assignment modal
                openSplitAssignmentModal();
            }
        }

        function openSplitAssignmentModal() {
            document.getElementById('splitModalTitle').textContent =
                `Assign ${splitCountyFeature.properties.NAME} County Regions`;

            // Populate zone selects
            const select1 = document.getElementById('splitRep1');
            const select2 = document.getElementById('splitRep2');

            select1.innerHTML = '<option value="">-- Select Zone --</option>';
            select2.innerHTML = '<option value="">-- Select Zone --</option>';

            // Pre-select current rep if county was assigned
            const currentAssignment = assignments[splitCountyId];
            const currentRepId = typeof currentAssignment === 'string' ? currentAssignment :
                (typeof currentAssignment === 'object' && currentAssignment.repId ? currentAssignment.repId : null);

            salesReps.forEach((rep, idx) => {
                const opt1 = document.createElement('option');
                opt1.value = rep.id;
                opt1.textContent = rep.name;
                if (currentRepId === rep.id) opt1.selected = true;
                select1.appendChild(opt1);

                const opt2 = document.createElement('option');
                opt2.value = rep.id;
                opt2.textContent = rep.name;
                select2.appendChild(opt2);
            });

            document.getElementById('splitModalOverlay').classList.add('visible');
        }

        function cancelSplitAssignment() {
            document.getElementById('splitModalOverlay').classList.remove('visible');
            cancelSplitMode();
        }

        function confirmSplitAssignment() {
            const rep1Id = document.getElementById('splitRep1').value;
            const rep2Id = document.getElementById('splitRep2').value;

            if (!rep1Id || !rep2Id) {
                alert('Please select a zone for each side');
                return;
            }

            if (rep1Id === rep2Id) {
                alert('Please select different zones for each side');
                return;
            }

            // Save the split assignment
            assignments[splitCountyId] = {
                split: true,
                line: splitPoints.slice(),
                rep1: rep1Id,
                rep2: rep2Id
            };

            saveToLocalStorage();

            // Close modal and exit split mode
            document.getElementById('splitModalOverlay').classList.remove('visible');

            splitMode = false;
            splitCountyId = null;
            splitCountyFeature = null;
            splitPoints = [];
            splitPolygons = null;

            document.getElementById('splitModeBanner').classList.remove('visible');
            svg.call(zoom);

            // Redraw map
            redrawMap();
            updateStats();
            renderRepList();
            updateLegend();
        }

        // Zone Management
        function addSalesRep() {
            const nameInput = document.getElementById('repName');
            const colorInput = document.getElementById('repColor');
            const priceInput = document.getElementById('repPrice');

            const name = nameInput.value.trim();
            if (!name) return;

            // Check if the name matches a basic color
            const colorFromName = getColorFromName(name);
            const finalColor = colorFromName || sanitizeColor(colorInput.value);

            // Get price adjustment (can be positive or negative)
            const priceValue = priceInput.value ? parseFloat(priceInput.value) : null;
            const price = (priceValue !== null && !isNaN(priceValue) && priceValue !== 0) ? priceValue : null;

            const rep = {
                id: 'rep_' + Date.now(),
                name: name,
                color: finalColor,
                price: price
            };

            salesReps.push(rep);
            nameInput.value = '';
            colorInput.value = getRandomColor();
            priceInput.value = '';

            saveToLocalStorage();
            renderRepList();
            updateStats();
            updateLegend();
        }

        function toggleCreateZoneSection() {
            const form = document.getElementById('createZoneForm');
            const icon = document.getElementById('createZoneExpandIcon');
            const isHidden = form.style.display === 'none';
            form.style.display = isHidden ? 'block' : 'none';
            icon.textContent = isHidden ? '−' : '+';
        }

        function createAndAssignZone() {
            const nameInput = document.getElementById('modalZoneName');
            const colorInput = document.getElementById('modalZoneColor');
            const priceInput = document.getElementById('modalZonePrice');

            const name = nameInput.value.trim();
            if (!name) {
                alert('Please enter a zone name');
                return;
            }

            if (!selectedCounty) {
                closeModal();
                return;
            }

            // Check if the name matches a basic color
            const colorFromName = getColorFromName(name);
            const finalColor = colorFromName || sanitizeColor(colorInput.value);

            // Get price adjustment
            const priceValue = priceInput.value ? parseFloat(priceInput.value) : null;
            const price = (priceValue !== null && !isNaN(priceValue) && priceValue !== 0) ? priceValue : null;

            // Create the zone
            const rep = {
                id: 'rep_' + Date.now(),
                name: name,
                color: finalColor,
                price: price
            };

            salesReps.push(rep);

            // Assign the county to the new zone
            assignments[selectedCounty.GEOID] = rep.id;

            // Reset form
            nameInput.value = '';
            colorInput.value = getRandomColor();
            priceInput.value = '';

            // Update UI
            saveToLocalStorage();
            renderRepList();
            updateStats();
            updateLegend();
            redrawMap();
            closeModal();
        }

        function editSalesRep(repId) {
            const rep = salesReps.find(r => r.id === repId);
            if (!rep) return;

            const newName = prompt('Enter new zone name:', rep.name);
            if (newName && newName.trim()) {
                rep.name = newName.trim();
                saveToLocalStorage();
                renderRepList();
                updateLegend();
                redrawMap();
            }
        }

        function deleteSalesRep(repId) {
            if (!confirm('Delete this zone and unassign all its counties?')) return;

            // Handle regular and split assignments
            Object.keys(assignments).forEach(countyId => {
                const assignment = assignments[countyId];
                if (isSplitAssignment(assignment)) {
                    if (assignment.rep1 === repId || assignment.rep2 === repId) {
                        // If rep is part of a split, remove the entire split
                        delete assignments[countyId];
                    }
                } else if (typeof assignment === 'object' && assignment.repId === repId) {
                    // New object format with custom color
                    delete assignments[countyId];
                } else if (assignment === repId) {
                    // Legacy string format
                    delete assignments[countyId];
                }
            });

            // Remove rep
            salesReps = salesReps.filter(r => r.id !== repId);

            saveToLocalStorage();
            renderRepList();
            redrawMap();
            updateStats();
            updateLegend();
        }

        function renderRepList() {
            const container = document.getElementById('repList');

            if (salesReps.length === 0) {
                container.innerHTML = '<p style="color: #888; text-align: center; padding: 20px;">No zones added yet</p>';
                return;
            }

            container.innerHTML = salesReps.map(rep => {
                const countyCount = getRepCountyCount(rep.id);
                const safeColor = sanitizeColor(rep.color);
                const safeName = escapeHtml(rep.name);
                const safeId = escapeHtml(rep.id);
                return `
                    <div class="rep-item">
                        <div class="rep-color" style="background: ${safeColor}"></div>
                        <div class="rep-info">
                            <div class="rep-name">${safeName}</div>
                            <div class="rep-counties">${countyCount} ${countyCount === 1 ? 'county' : 'counties'}</div>
                        </div>
                        <div class="rep-actions">
                            <button class="btn btn-secondary btn-sm" data-rep-id="${safeId}" onclick="editSalesRep(this.dataset.repId)">Edit</button>
                            <button class="btn btn-danger btn-sm" data-rep-id="${safeId}" onclick="deleteSalesRep(this.dataset.repId)">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getRepCountyCount(repId) {
            let count = 0;
            Object.values(assignments).forEach(assignment => {
                if (isSplitAssignment(assignment)) {
                    if (assignment.rep1 === repId) count += 0.5;
                    if (assignment.rep2 === repId) count += 0.5;
                } else if (typeof assignment === 'object' && assignment.repId === repId) {
                    // New object format with custom color
                    count += 1;
                } else if (assignment === repId) {
                    // Legacy string format
                    count += 1;
                }
            });
            return count;
        }

        function updateStats() {
            let assignedCount = 0;
            let splitCount = 0;

            Object.values(assignments).forEach(assignment => {
                if (isSplitAssignment(assignment)) {
                    assignedCount += 1;
                    splitCount += 1;
                } else {
                    assignedCount += 1;
                }
            });

            const totalCounties = STATE_CONFIG[currentState].counties().features.length;

            document.getElementById('totalReps').textContent = salesReps.length;
            document.getElementById('assignedCounties').textContent = assignedCount;
            document.getElementById('unassignedCounties').textContent = totalCounties - assignedCount;
            document.getElementById('totalCounties').textContent = totalCounties;
        }

        function updateLegend() {
            const container = document.getElementById('legendItems');

            let html = `
                <div class="legend-item">
                    <div class="legend-color" style="background: #d0d8e0"></div>
                    <span>Unassigned</span>
                </div>
            `;

            salesReps.forEach(rep => {
                const priceFormatted = rep.price ? formatPriceAdjustment(rep.price) : '';
                const priceClass = rep.price ? getPriceClass(rep.price) : '';
                const priceHtml = priceFormatted ? `<span class="price-value ${priceClass}" style="margin-left: 8px;">${priceFormatted}</span>` : '';

                html += `
                    <div class="legend-item">
                        <div class="legend-color" style="background: ${sanitizeColor(rep.color)}"></div>
                        <span>${escapeHtml(rep.name)}${priceHtml}</span>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function getRandomColor() {
            // Meridian Waste-inspired professional color palette
            const colors = ['#f7941d', '#1a2a3a', '#2d7d46', '#c0392b', '#2980b9', '#8e44ad', '#16a085', '#d35400'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        // Export
        function exportMap() {
            const svgElement = document.querySelector('#map svg');
            const serializer = new XMLSerializer();

            // Clone SVG and add styles inline for export
            const svgClone = svgElement.cloneNode(true);

            // Use wider dimensions for export to capture full map
            const exportWidth = 1100;
            const exportHeight = height;
            const viewBoxOffsetX = -100; // Shift viewBox left to capture western counties

            // Set explicit dimensions
            svgClone.setAttribute('width', exportWidth);
            svgClone.setAttribute('height', exportHeight);
            svgClone.setAttribute('viewBox', `${viewBoxOffsetX} 0 ${exportWidth} ${exportHeight}`);

            // Reset any zoom/pan transform to export the full map
            const gElement = svgClone.querySelector('g');
            if (gElement) {
                gElement.removeAttribute('transform');
            }

            // Add white background
            const bg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            bg.setAttribute('width', '100%');
            bg.setAttribute('height', '100%');
            bg.setAttribute('fill', '#e8eef3');
            svgClone.insertBefore(bg, svgClone.firstChild);

            // Inline styles for county paths (borders)
            svgClone.querySelectorAll('.county, .split-county-half').forEach(el => {
                el.style.stroke = '#1a2a3a';
                el.style.strokeWidth = '1px';
            });

            // Inline styles for split county borders
            svgClone.querySelectorAll('.split-county-border').forEach(el => {
                el.style.stroke = '#1a2a3a';
                el.style.strokeWidth = '1px';
            });

            // Inline styles for split divider lines
            svgClone.querySelectorAll('.split-divider').forEach(el => {
                el.style.stroke = '#1a2a3a';
                el.style.strokeWidth = '2px';
            });

            // Make county labels smaller for export
            svgClone.querySelectorAll('.county-label').forEach(el => {
                el.style.fontSize = '5px';
                el.style.fill = '#1a2a3a';
                el.style.textAnchor = 'middle';
                el.style.fontFamily = 'Roboto, Arial, sans-serif';
                el.style.fontWeight = '500';
            });

            // Inline styles for city dots
            svgClone.querySelectorAll('.city-dot').forEach(el => {
                el.style.fill = '#1a2a3a';
                el.style.stroke = '#ffffff';
                el.style.strokeWidth = '1px';
            });

            // Inline styles for city labels (scaled down proportionally like county labels)
            svgClone.querySelectorAll('.city-label').forEach(el => {
                el.style.fontSize = '4px';
                el.style.fill = '#1a2a3a';
                el.style.fontFamily = 'Roboto, Arial, sans-serif';
                el.style.fontWeight = '600';
            });

            const svgString = serializer.serializeToString(svgClone);
            const svgBlob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
            const url = URL.createObjectURL(svgBlob);

            // Build legend data for export using zone prices directly
            const legendItems = [{ name: 'Unassigned', color: '#d0d8e0', price: null }];
            salesReps.forEach(rep => {
                legendItems.push({
                    name: rep.name,
                    color: rep.color,
                    price: rep.price || null
                });
            });

            // Calculate legend dimensions
            const legendPadding = 20;
            const legendItemHeight = 24;
            const legendItemWidth = 180; // Wider to accommodate price
            const itemsPerRow = Math.floor((exportWidth - legendPadding * 2) / legendItemWidth);
            const legendRows = Math.ceil(legendItems.length / itemsPerRow);
            const totalLegendHeight = legendPadding + 20 + (legendRows * legendItemHeight) + legendPadding;

            // Create canvas with space for legend
            const totalHeight = exportHeight + totalLegendHeight;
            const canvas = document.createElement('canvas');
            canvas.width = exportWidth * 2; // Higher resolution
            canvas.height = totalHeight * 2;
            const ctx = canvas.getContext('2d');
            ctx.scale(2, 2);

            const img = new Image();
            img.onerror = function() {
                alert('Failed to generate image export');
                URL.revokeObjectURL(url);
            };
            img.onload = function() {
                // Draw map background
                ctx.fillStyle = '#e8eef3';
                ctx.fillRect(0, 0, exportWidth, totalHeight);
                ctx.drawImage(img, 0, 0);

                // Draw legend section below the map
                const legendStartY = exportHeight + legendPadding;

                // Draw legend background
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(legendPadding - 10, exportHeight + 5, exportWidth - legendPadding * 2 + 20, totalLegendHeight - 10);
                ctx.strokeStyle = '#e0e0e0';
                ctx.lineWidth = 1;
                ctx.strokeRect(legendPadding - 10, exportHeight + 5, exportWidth - legendPadding * 2 + 20, totalLegendHeight - 10);

                // Draw "Legend" title
                ctx.fillStyle = '#1a2a3a';
                ctx.font = 'bold 14px Roboto, Arial, sans-serif';
                ctx.fillText('Legend', legendPadding, legendStartY);

                // Draw zone legend items horizontally
                let currentX = legendPadding;
                let currentY = legendStartY + 20;

                legendItems.forEach((item, index) => {
                    // Check if we need to wrap to next row
                    if (currentX + legendItemWidth > exportWidth - legendPadding) {
                        currentX = legendPadding;
                        currentY += legendItemHeight;
                    }

                    // Draw color box
                    ctx.fillStyle = item.color;
                    ctx.fillRect(currentX, currentY - 12, 16, 16);
                    ctx.strokeStyle = 'rgba(0,0,0,0.1)';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(currentX, currentY - 12, 16, 16);

                    // Draw label
                    ctx.fillStyle = '#333333';
                    ctx.font = '12px Roboto, Arial, sans-serif';
                    ctx.fillText(item.name, currentX + 22, currentY);

                    // Draw price if present
                    if (item.price) {
                        const nameWidth = ctx.measureText(item.name).width;
                        const priceFormatted = item.price > 0 ? `+$${item.price}` : `-$${Math.abs(item.price)}`;
                        const priceColor = item.price > 0 ? '#27ae60' : '#c0392b';
                        ctx.fillStyle = priceColor;
                        ctx.font = 'bold 12px Roboto, Arial, sans-serif';
                        ctx.fillText(priceFormatted, currentX + 22 + nameWidth + 6, currentY);
                    }

                    currentX += legendItemWidth;
                });

                // Download
                const link = document.createElement('a');
                link.download = 'nc-territory-map.png';
                link.href = canvas.toDataURL('image/png');
                link.click();

                URL.revokeObjectURL(url);
            };
            img.src = url;
        }

        // Close modal on outside click
        document.getElementById('modalOverlay').addEventListener('click', (e) => {
            if (e.target.id === 'modalOverlay') closeModal();
        });

        document.getElementById('splitModalOverlay').addEventListener('click', (e) => {
            if (e.target.id === 'splitModalOverlay') cancelSplitAssignment();
        });

        // Enter key for adding zone
        document.getElementById('repName').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addSalesRep();
        });

        document.getElementById('repPrice').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addSalesRep();
        });

        // Auto-update color picker when zone name matches a color
        document.getElementById('repName').addEventListener('input', (e) => {
            const colorFromName = getColorFromName(e.target.value);
            if (colorFromName) {
                document.getElementById('repColor').value = colorFromName;
            }
        });

        // Auto-update color picker in modal create zone form
        document.getElementById('modalZoneName').addEventListener('input', (e) => {
            const colorFromName = getColorFromName(e.target.value);
            if (colorFromName) {
                document.getElementById('modalZoneColor').value = colorFromName;
            }
        });

        // Update color picker when zone selection changes in modal
        document.getElementById('repSelect').addEventListener('change', (e) => {
            if (isUpdatingModal) return; // Skip if programmatic update
            const repId = e.target.value;
            if (repId) {
                const rep = salesReps.find(r => r.id === repId);
                if (rep) {
                    document.getElementById('countyColorPicker').value = rep.color;
                }
            }
        });

        // Update color picker when zone selection changes in multi-select bar
        document.getElementById('multiSelectRep').addEventListener('change', (e) => {
            const repId = e.target.value;
            if (repId) {
                const rep = salesReps.find(r => r.id === repId);
                if (rep) {
                    document.getElementById('multiSelectColor').value = rep.color;
                }
            }
        });

        // ESC key to cancel split mode or clear selection
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (splitMode) {
                    cancelSplitMode();
                } else if (selectedCounties.size > 0) {
                    clearSelection();
                }
            }
        });

        // Sidebar toggle functionality
        document.getElementById('sidebarToggle').addEventListener('click', () => {
            const sidebar = document.getElementById('sidebar');
            const toggle = document.getElementById('sidebarToggle');
            sidebar.classList.toggle('collapsed');
            // Update arrow direction
            toggle.innerHTML = sidebar.classList.contains('collapsed') ? '&#9654;' : '&#9664;';
        });

        // Legend toggle functionality
        document.getElementById('legendClose').addEventListener('click', () => {
            document.getElementById('legend').classList.add('hidden');
            document.getElementById('legendShowBtn').classList.add('visible');
        });

        document.getElementById('legendShowBtn').addEventListener('click', () => {
            document.getElementById('legend').classList.remove('hidden');
            document.getElementById('legendShowBtn').classList.remove('visible');
        });
    </script>
</body>
</html>
